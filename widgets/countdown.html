<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Countdown</title>
    <style>
        :root {
            --panel-color: #f7f7f7; --fg-color: #1f1f1f; --fg-light-color: #8a8a8e;
            --ring-color: #e5e5e5; --border-color: rgba(0,0,0,0.08);
            --accent-color: #5e5ce6;
        }
        .dark-theme {
            --panel-color: #1c1c1e; --bg-color: #2c2c2e; --fg-color: #ffffff;
            --fg-light-color: #8d8d92; --ring-color: #3a3a3c; --border-color: rgba(255,255,255,0.1);
        }

        body { margin: 0; padding: 0; background-color: #f7f7f7; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        body.compact .widget-container { padding: 16px; }

        .widget-container {
            position: relative; width: 100%; max-width: 380px; background-color: var(--panel-color);
            border-radius: 16px; padding: 24px; text-align: center; box-sizing: border-box;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08); overflow: hidden;
            transition: background-color 0.3s ease, color 0.3s ease, min-height 0.4s cubic-bezier(0.2, 0.9, 0.3, 1);
            color: var(--fg-color);
        }
        .widget-container.settings-active { min-height: 480px; }
        
        .settings-toggle { position: absolute; top: 16px; right: 16px; z-index: 20; background: none; border: none; cursor: pointer; padding: 4px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .settings-toggle:hover { background-color: var(--ring-color); }
        .settings-toggle svg { width: 20px; height: 20px; fill: var(--fg-light-color); }
        
        .settings-panel {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(var(--panel-color-rgb, 247, 247, 247), 0.7);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            z-index: 10; padding: 24px; box-sizing: border-box;
            display: grid; grid-template-rows: auto 1fr auto; gap: 16px;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        .dark-theme .settings-panel { --panel-color-rgb: 28, 28, 30; }
        .settings-panel.visible { opacity: 1; pointer-events: auto; }

        .settings-panel-header { display: flex; justify-content: space-between; align-items: center; }
        .settings-panel-header h2 { font-size: 1rem; font-weight: 600; margin: 0; }
        
        .settings-content { display: flex; flex-direction: column; gap: 24px; overflow-y: auto; padding: 4px 0; }
        .settings-section { display: flex; flex-direction: column; gap: 12px; }
        .settings-header { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--fg-light-color); text-align: left; margin: 0; }
        .setting-row { display: flex; justify-content: space-between; align-items: center; }
        .setting-row label { font-size: 0.875rem; }
        
        .preset-tabs { 
            position: relative; 
            display: flex; 
            justify-content: space-around; 
            border-bottom: 1px solid var(--border-color);
            overflow: hidden; 
        }
        .btn-preset { 
            background: none; 
            color: var(--fg-light-color); 
            border: none; 
            padding: 10px 0; 
            font-size: 0.875rem; 
            font-weight: 500; 
            cursor: pointer; 
            transition: color 0.3s ease; 
            flex-grow: 1; 
            white-space: nowrap;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .btn-preset.active { color: var(--accent-color); font-weight: 600; }
        .btn-preset:disabled { color: var(--fg-light-color) !important; cursor: default; }
        .preset-indicator { 
            position: absolute; 
            bottom: -1px; 
            left: 0; 
            height: 2px; 
            background-color: var(--accent-color); 
            border-radius: 1px; 
            transition: transform 0.4s cubic-bezier(0.2, 0.9, 0.3, 1), width 0.4s cubic-bezier(0.2, 0.9, 0.3, 1);
        }

        .custom-controls input { background-color: var(--ring-color); border: 1px solid var(--border-color); color: var(--fg-color); border-radius: 6px; padding: 4px 8px; font-family: inherit; font-size: 0.875rem; width: 60%; }
        
        .setting-row.two-inputs {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 8px 12px;
    align-items: center;
}
.setting-row.two-inputs label {
    font-size: 0.875rem;
    text-align: right;
    color: var(--fg-light-color);
}
.setting-row.two-inputs input {
    width: 100%;
    padding: 6px 8px;
    font-size: 0.875rem;
}
@media (max-width: 360px) {
    .setting-row.two-inputs { grid-template-columns: 1fr; }
    .setting-row.two-inputs label { text-align: left; }
}

/* Tighten datetime parts (WebKit) */
.input-compact::-webkit-datetime-edit { padding: 0 2px; }
.input-compact::-webkit-datetime-edit-fields-wrapper { display: inline-flex; gap: 2px; }
.input-compact::-webkit-calendar-picker-indicator { opacity: .7; }

/* Prevent horizontal overflow + mobile stack */
.setting-row.two-inputs > * { min-width: 0; }
@media (max-width: 360px) {
  .setting-row.two-inputs { grid-template-columns: 1fr; row-gap: 6px; }
  .setting-row.two-inputs label { text-align: left; }
}

        .custom-controls.disabled { opacity: 0.5; pointer-events: none; }
        
        /* Badge-style unit selector */
        .horizontal-toggles { display: flex; justify-content: space-around; align-items: center; gap: 14px; margin-top: 10px; }
        .unit-toggle { display: flex; flex-direction: column; align-items: center; gap: 6px; cursor: pointer; user-select: none; }
        .unit-toggle input { position: absolute; opacity: 0; pointer-events: none; }
        .unit-dot { width: 18px; height: 18px; border-radius: 999px; border: 2px solid var(--fg-light-color); background: transparent; transition: background-color .2s ease, border-color .2s ease, box-shadow .2s ease; }
        .unit-toggle input:checked + .unit-dot { background: var(--accent-color); border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(0,0,0,0); }
        .unit-toggle-label { font-size: 0.75rem; font-weight: 600; color: var(--fg-light-color); letter-spacing: .02em; }
        .unit-toggle:focus-within .unit-dot { box-shadow: 0 0 0 3px rgba(130,163,26,.25); }
        
        .switch-container { position: relative; width: 44px; height: 24px; }
        .switch-container input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: var(--ring-color); transition: 0.3s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 2px; bottom: 2px; background-color: white; transition: 0.3s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(20px); }
        
        .settings-footer { display: flex; justify-content: flex-end; align-items: center; }
        .dark-mode-toggle { display: flex; align-items: center; }
        .dark-mode-toggle svg { width: 14px; height: 14px; fill: var(--fg-light-color); transition: opacity 0.3s ease; }
        .sun-icon { margin-right: 8px; }
        .moon-icon { margin-left: 8px; }
        .dark-theme .dark-mode-toggle .sun-icon { opacity: 1; }
        .dark-theme .dark-mode-toggle .moon-icon { opacity: 0; }
        .dark-mode-toggle .sun-icon { opacity: 0; }
        .dark-mode-toggle:not(.dark-theme) .moon-icon { opacity: 1; }

        .subtitle { font-size: 0.875rem; font-weight: 500; opacity: 0.6; margin: 0 0 4px 0; letter-spacing: 0.08em; }
        .title { font-size: 1.125rem; font-weight: 600; margin: 0 0 20px 0; }
        .timer-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px; }
        .timer-unit { display: flex; flex-direction: column; }
        .timer-unit .number { font-size: 2.25rem; font-weight: 700; line-height: 1.1; color: var(--accent-color); font-variant-numeric: tabular-nums; }
        .timer-unit .label { font-size: 0.75rem; font-weight: 500; opacity: 0.5; text-transform: uppercase; letter-spacing: 0.08em; }
        .finished-message { display: none; font-size: 1.125rem; font-weight: 600; padding: 32px 0; }
        .progress-container { display: none; width: 100%; height: 8px; background-color: var(--ring-color); border-radius: 4px; overflow: hidden; margin-bottom: 12px; }
        .progress-bar { width: 0%; height: 100%; background-color: var(--accent-color); border-radius: 4px; transition: width 0.5s ease; }
        .footer { font-size: 0.75rem; font-weight: 500; opacity: 0.5; margin: 0; }
        .custom-controls {
    transition: max-height 0.4s ease, opacity 0.4s ease, margin-top 0.4s ease;
    max-height: 0;
    opacity: 0;
    overflow: hidden;
    margin-top: 0 !important;
}
.custom-controls.visible {
    max-height: 150px;
    opacity: 1;
    margin-top: 16px !important;
}
.setting-row.two-inputs {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 8px 12px;
    align-items: center;
}
.setting-row.two-inputs label {
    font-size: 0.875rem;
    text-align: right;
    color: var(--fg-light-color);
}
.setting-row.two-inputs input {
    width: 18px;
    padding: 6px 8px;
    font-size: 0.875rem;
}
.finished-message {
    font-size: 1.125rem;
    font-weight: 600;
    padding: 32px 0;
    line-height: 1.4;
    opacity: 0.8;
}

    </style>
</head>
<body>
    <div class="widget-container" id="widget-container">
        <button class="settings-toggle" id="settings-toggle" aria-label="Open Settings">
            <svg id="gear-icon" viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.44,0.17-0.48,0.41L9.18,5.03C8.59,5.27,8.06,5.59,7.56,5.97L5.17,5.01C4.95,4.94,4.7,5.01,4.58,5.23L2.66,8.55 c-0.11,0.2-0.06,0.47,0.12,0.61l2.03,1.58C4.74,11.06,4.70,11.38,4.70,11.70c0,0.32,0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.42,2.22 c0.04,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.48-0.41l0.42-2.22c0.59-0.24,1.12-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0.01,0.59-0.22l1.92-3.32c0.11-0.2,0.06-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
            <svg id="close-icon" viewBox="0 0 24 24" style="display: none;"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
        <div class="settings-panel" id="settings-panel">
            <div class="settings-panel-header">
                <h2>Countdown Settings</h2>
            </div>
            <div class="settings-content">
                <div class="settings-section">
                    <div class="preset-tabs"><div class="preset-indicator" id="preset-indicator"></div><button class="btn-preset" data-preset="1h">1 Hour</button><button class="btn-preset" data-preset="24h">24 Hours</button><button class="btn-preset" data-preset="7d">7 Days</button><button class="btn-preset" data-preset="custom" >Custom</button></div>
                </div>
                <div class="settings-section custom-controls" id="custom-controls">
                    <h2 class="settings-header">Custom Deadline</h2>
                  <div class="setting-row two-inputs">
                      <label for="start-date-input">Start</label>
                      <input type="datetime-local" id="start-date-input">
                      <label for="target-date-input">End</label>
                      <input type="datetime-local" id="target-date-input">
                  </div>
                </div>
                <div class="settings-section">
                  <h2 class="settings-header">Display</h2>
                  <div class="horizontal-toggles" role="group" aria-label="Units to display">
                    <label class="unit-toggle">
                      <input type="checkbox" id="unit-days" data-unit="days" checked>
                      <span class="unit-dot" aria-hidden="true"></span>
                      <span class="unit-toggle-label">Days</span>
                    </label>
                    <label class="unit-toggle">
                      <input type="checkbox" id="unit-hours" data-unit="hours" checked>
                      <span class="unit-dot" aria-hidden="true"></span>
                      <span class="unit-toggle-label">Hours</span>
                    </label>
                    <label class="unit-toggle">
                      <input type="checkbox" id="unit-mins" data-unit="mins" checked>
                      <span class="unit-dot" aria-hidden="true"></span>
                      <span class="unit-toggle-label">Mins</span>
                    </label>
                    <label class="unit-toggle">
                      <input type="checkbox" id="unit-secs" data-unit="secs" checked>
                      <span class="unit-dot" aria-hidden="true"></span>
                      <span class="unit-toggle-label">Secs</span>
                    </label>
                  </div>
                </div>
            </div>
            <div class="settings-footer">
                <div class="dark-mode-toggle" aria-label="Toggle Theme">
                    <svg class="sun-icon" viewBox="0 0 24 24"><path d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1S11,19.45,11,20z"/></svg>
                    <div class="switch-container"><input type="checkbox" id="dark-mode-checkbox"><label for="dark-mode-checkbox" class="slider"></label></div>
                    <svg class="moon-icon" viewBox="0 0 24 24"><path d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.10-1.36 c-0.98,1.37-2.58,2.26-4.40,2.26c-2.98,0-5.40-2.42-5.40-5.40c0-1.82,0.89-3.42,2.26-4.40C12.92,3.04,12.46,3,12,3z"/></svg>
                </div>
            </div>
        </div>
        <div id="main-display">
            <p id="subtitle" class="subtitle"></p>
            <h1 id="title" class="title"></h1>
            <div id="timer-grid" class="timer-grid">
                <div class="timer-unit" data-unit="days"><span id="days" class="number">00</span><span class="label">Days</span></div>
                <div class="timer-unit" data-unit="hours"><span id="hours" class="number">00</span><span class="label">Hours</span></div>
                <div class="timer-unit" data-unit="minutes"><span id="minutes" class="number">00</span><span class="label">Mins</span></div>
                <div class="timer-unit" data-unit="seconds"><span id="seconds" class="number">00</span><span class="label">Secs</span></div>
            </div>
            <div id="finished-message" class="finished-message"></div>
            <div id="progress-container" class="progress-container"><div id="progress-bar" class="progress-bar"></div></div>
            <p id="footer" class="footer"></p>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const params = new URLSearchParams(window.location.search);
    const root = document.documentElement;
    
    const elements = {
        container: document.getElementById('widget-container'), mainDisplay: document.getElementById('main-display'),
        title: document.getElementById('title'), subtitle: document.getElementById('subtitle'), footer: document.getElementById('footer'),
        timerGrid: document.getElementById('timer-grid'), finishedMessage: document.getElementById('finished-message'),
        progressContainer: document.getElementById('progress-container'), progressBar: document.getElementById('progress-bar'),
        settings: {
            toggle: document.getElementById('settings-toggle'), panel: document.getElementById('settings-panel'),
            darkModeCheckbox: document.getElementById('dark-mode-checkbox'),
            unitToggles: document.querySelectorAll('.settings-panel input[data-unit]'),
            presetIndicator: document.getElementById('preset-indicator'), presetBtns: document.querySelectorAll('.btn-preset'),
            customControls: document.getElementById('custom-controls'),
            targetDateInput: document.getElementById('target-date-input'),
            startDateInput: document.getElementById('start-date-input'),
            gearIcon: document.getElementById('gear-icon'), 
            closeIcon: document.getElementById('close-icon'),
        }
    };
    
    let config = {};
    let settings = {};
    let timerInterval;

    const UNIT_MAP = { days:'days', hours:'hours', mins:'minutes', secs:'seconds' };

    const toLocalISOString = (date) => {
        if (!date || isNaN(date.getTime())) return "";
        const tzoffset = (new Date()).getTimezoneOffset() * 60000;
        return (new Date(date - tzoffset)).toISOString().slice(0, 16);
    };
    const calculateDate = (offsetHours) => new Date(Date.now() + offsetHours * 60 * 60 * 1000);
    const presets = {
        '1h': { name: '1 Hour', target: () => calculateDate(1), start: () => new Date() },
        '24h': { name: '24 Hours', target: () => calculateDate(24), start: () => new Date() },
        '7d': { name: '7 Days', target: () => calculateDate(168), start: () => new Date() },
    };
    

    const updateCountdown = () => {
        const now = new Date().getTime();

        // Handle "waiting" state if start date is in the future
        if (config.startDate && now < config.startDate.getTime()) {
            elements.timerGrid.style.display = 'none';
            elements.progressContainer.style.display = 'none';
            elements.finishedMessage.style.display = 'block';
            
            const timeUntilStart = config.startDate.getTime() - now;
            const days = Math.floor(timeUntilStart / (1000*60*60*24));
            const hours = Math.floor((timeUntilStart % (1000*60*60*24)) / (1000*60*60));
            elements.finishedMessage.innerHTML = `Starts in<br>${days}d ${hours}h`;
            return;
        }

        // Ensure main display is visible if we've passed the start time
        elements.timerGrid.style.display = 'grid';
        elements.finishedMessage.style.display = 'none';

        if (!config.targetDate || isNaN(config.targetDate.getTime())) return;
        
        const distance = config.targetDate.getTime() - now;
        if (distance < 0) {
            clearInterval(timerInterval);
            elements.timerGrid.style.display = 'none';
            elements.finishedMessage.style.display = 'block';
            elements.finishedMessage.textContent = (config.title || 'Event') + ' has started!';
            if (config.startDate) elements.progressBar.style.width = '100%';
            return;
        }
        const timeParts = {
            days: String(Math.floor(distance / (1000*60*60*24))),
            hours: String(Math.floor((distance % (1000*60*60*24)) / (1000*60*60))),
            minutes: String(Math.floor((distance % (1000*60*60)) / (1000*60))),
            seconds: String(Math.floor((distance % (1000*60)) / 1000)),
        };
        Object.keys(timeParts).forEach(part => {
            const el = document.getElementById(part);
            if (el) el.textContent = timeParts[part].padStart(2, '0');
        });
        
        if (config.startDate && !isNaN(config.startDate.getTime()) && config.targetDate > config.startDate) {
            elements.progressContainer.style.display = 'block';
            const total = config.targetDate.getTime() - config.startDate.getTime();
            const elapsed = now - config.startDate.getTime();
            let progress = (elapsed / total) * 100;
            progress = Math.max(0, Math.min(100, progress));
            elements.progressBar.style.width = `${progress}%`;
        } else {
            elements.progressContainer.style.display = 'none';
        }
    };

    const showSettingsPanel = (show) => {
        elements.settings.panel.classList.toggle('visible', show);
        elements.container.classList.toggle('settings-active', show);
        elements.settings.gearIcon.style.display = show ? 'none' : 'block';
        elements.settings.closeIcon.style.display = show ? 'block' : 'none';

        // Pause timer when settings are open, resume on close
        if (show) {
            clearInterval(timerInterval);
        } else {
            updateCountdown(); // Update immediately on close
            timerInterval = setInterval(updateCountdown, 1000);
        }

        if (show) {
            setTimeout(updatePresetHighlighting, 50);
        }
    };

    const saveSettings = () => localStorage.setItem('countdownSettingsV5', JSON.stringify(settings));
    const loadSettings = () => {
        try {
            const saved = JSON.parse(localStorage.getItem('countdownSettingsV5')) || {};
            const vu = saved.visibleUnits || {};
            settings = {
                visibleUnits: {
                  days:    vu.days    !== false,
                  hours:   vu.hours   !== false,
                  minutes: vu.minutes !== false,
                  seconds: vu.seconds !== false,
                },
                isDark: saved.isDark || false,
                activePreset: saved.activePreset || '24h',
                customTargetDate: saved.customTargetDate || null,
                customStartDate: saved.customStartDate || null,
            };
        } catch (e) { localStorage.removeItem('countdownSettingsV5'); }
    };
    
    const applyTheme = (isDark, fromLoad = false) => {
        settings.isDark = isDark;
        elements.container.classList.toggle('dark-theme', isDark);
        elements.settings.darkModeCheckbox.checked = isDark;
        if (!fromLoad) saveSettings();
    };

    // sync visibility of grid units + checkboxes
    const applyUnitVisibility = (fromLoad = false) => {
        let count = 0;
        document.querySelectorAll('.timer-unit').forEach(unitEl => {
            const key = unitEl.dataset.unit; // days|hours|minutes|seconds
            const visible = settings.visibleUnits[key] !== false;
            unitEl.style.display = visible ? 'flex' : 'none';
            if (visible) count++;
        });
        elements.timerGrid.style.gridTemplateColumns = `repeat(${Math.max(1, count)}, 1fr)`;
        // sync the checkboxes state
        elements.settings.unitToggles.forEach(cb => {
            const mapped = UNIT_MAP[cb.dataset.unit];
            cb.checked = !!settings.visibleUnits[mapped];
        });
        if (!fromLoad) saveSettings();
    };
    
    const updatePresetHighlighting = () => {
        const btns = Array.from(elements.settings.presetBtns);
        let activeBtn = null;
        btns.forEach(btn => {
            const isMatch = btn.dataset.preset === settings.activePreset;
            btn.classList.toggle('active', isMatch);
            if (isMatch) activeBtn = btn;
        });
        // This new line toggles the visibility of the custom controls
        elements.settings.customControls.classList.toggle('visible', settings.activePreset === 'custom');
        
        const indicator = elements.settings.presetIndicator;
        if (activeBtn) {
            indicator.style.width = `${activeBtn.offsetWidth}px`;
            indicator.style.transform = `translateX(${activeBtn.offsetLeft}px)`;
        }
    };

    const applyPreset = (presetKey) => {
        settings.activePreset = presetKey;
        if (presetKey !== 'custom') {
            const preset = presets[presetKey];
            config.targetDate = preset.target();
            config.startDate = preset.start();
            settings.customTargetDate = config.targetDate.toISOString();
            settings.customStartDate = config.startDate.toISOString();
        } else {
            config.targetDate = settings.customTargetDate ? new Date(settings.customTargetDate) : calculateDate(24);
            config.startDate = settings.customStartDate ? new Date(settings.customStartDate) : null;
        }
        elements.settings.targetDateInput.value = toLocalISOString(config.targetDate);
        elements.settings.startDateInput.value = toLocalISOString(config.startDate);
        updatePresetHighlighting();
        updateCountdown();
        saveSettings();
    };

    const handleCustomDateChange = () => {
        settings.activePreset = 'custom';
        const targetValue = elements.settings.targetDateInput.value;
        const startValue = elements.settings.startDateInput.value;
        config.targetDate = targetValue ? new Date(targetValue) : calculateDate(24);
        config.startDate = startValue ? new Date(startValue) : null;
        settings.customTargetDate = config.targetDate.toISOString();
        settings.customStartDate = config.startDate ? config.startDate.toISOString() : null;
        updatePresetHighlighting();
        updateCountdown();
        saveSettings();
    };
    
   
    
    elements.settings.toggle.addEventListener('click', () => {
        const isCurrentlyVisible = elements.settings.panel.classList.contains('visible');
        showSettingsPanel(!isCurrentlyVisible);
    });
    
    elements.settings.darkModeCheckbox.addEventListener('change', (e) => applyTheme(e.target.checked));
    // handle badge checkboxes (map mins/secs -> minutes/seconds)
    elements.settings.unitToggles.forEach(cb => cb.addEventListener('change', (e) => {
        const mapped = UNIT_MAP[e.target.dataset.unit];
        settings.visibleUnits[mapped] = e.target.checked;
        applyUnitVisibility();
    }));
    elements.settings.presetBtns.forEach(btn => btn.addEventListener('click', (e) => applyPreset(e.currentTarget.dataset.preset)));
    elements.settings.targetDateInput.addEventListener('input', handleCustomDateChange);
    elements.settings.startDateInput.addEventListener('input', handleCustomDateChange);
    
    // Ajouter un écouteur de redimensionnement pour mettre à jour l'indicateur
    window.addEventListener('resize', updatePresetHighlighting);
    
    const init = () => {
        if (params.get("compact") === "1") document.body.classList.add("compact");
        const getHexColor = (name) => (/^[0-9a-fA-F]{6}$/.test(params.get(name)) ? params.get(name) : null);
        const colors = { bg: getHexColor("bg"), panel: getHexColor("panel"), fg: getHexColor("fg"), accent: getHexColor("accent"), ring: getHexColor("ring") };
        Object.entries(colors).forEach(([key, value]) => { if (value) root.style.setProperty(`--${key}-color`, `#${value}`); });

        config.title = params.get("title")?.trim() || "Event Countdown";
        if (params.has("date")) {
            config.targetDate = new Date(params.get("date"));
            config.startDate = params.has("start") ? new Date(params.get("start")) : null;
            settings.activePreset = "custom";
            settings.customTargetDate = config.targetDate.toISOString();
            settings.customStartDate = config.startDate ? config.startDate.toISOString() : null;
        } else {
            loadSettings();
        }
        
        applyPreset(settings.activePreset);
        applyTheme(settings.isDark, true);
        applyUnitVisibility(true);
        
        elements.title.textContent = config.title;
        if(config.subtitle) elements.subtitle.textContent = config.subtitle; else elements.subtitle.style.display = 'none';
        if(config.footer) elements.footer.textContent = config.footer; else elements.footer.style.display = 'none';
        
        updateCountdown();
        timerInterval = setInterval(updateCountdown, 1000);
    };

    init();
});
</script>
</body>
</html>