<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Countdown</title>
<!--
  Widget Countdown – Params supportés (URL)
  - title=Texte
  - date=YYYY-MM-DDTHH:mm (Z ou +02:00) | tz=Europe/Paris ou +02:00
  - duration / minutes=Nombre (1–720)
  - units=combinaison d,h,m,s (ex: hm, dms)
  - theme=light|dark|violet|blue|green|pink|gold
  - accent=HEX sans # (si pas de preset)
  - footer=Texte
  - finish=Texte à l’échéance
  - lock=1 (masquer paramètres)
  - compact=1 (padding réduit)
-->
<style>
/* =================== Theme tokens =================== */
:root{
  --bg-color:#ffffff;
  --panel-color:#ffffff;
  --fg-color:#1f1f1f;
  --fg-light-color:#8a8a8e;
  --ring-color:#e5e5e5;
  --border-color:rgba(0,0,0,0.08);
  --accent-color:#5e5ce6; /* remplacé par var(--fg-color) en mode "default" */
  --reset-accent:#82A31A; /* vert French Pépite */
}
.dark-theme{
  --bg-color:#1c1c1e;
  --panel-color:#2c2c2e;
  --fg-color:#ffffff;
  --fg-light-color:#8d8d92;
  --ring-color:#3a3a3c;
  --border-color:rgba(255,255,255,0.1);
}

/* =================== Layout =================== */
body{
  margin:0; padding:0; background: transparent !important;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  min-height:100vh; display:flex; align-items:center; justify-content:center;
  transition:background-color .3s ease;
}
body.compact .widget-container{ padding:16px; }

.widget-container{
  position:relative; width:100%; max-width:380px; color:var(--fg-color);
  background:var(--panel-color); border-radius:16px; padding:24px; box-sizing:border-box;
  box-shadow:0 8px 32px rgba(0,0,0,.08); overflow:hidden;
  transition:background-color .3s ease,color .3s ease,min-height .4s cubic-bezier(.2,.9,.3,1);
}
.widget-container.settings-active{ min-height:520px; }

/* Settings toggle */
.settings-toggle{
  position:absolute; top:16px; right:16px; z-index:20; background:none; border:none; cursor:pointer;
  padding:6px; border-radius:50%; display:flex; align-items:center; justify-content:center;
  transition:transform .15s ease, background-color .2s ease;
}
.settings-toggle:hover{ background:rgba(0,0,0,.06); transform:scale(1.06); }
.dark-theme .settings-toggle:hover{ background:rgba(255,255,255,.08); }
.settings-toggle svg{ width:20px; height:20px; fill:var(--fg-light-color); }

/* Settings panel (glass) */
.settings-panel{
  position:absolute; inset:0; z-index:10; padding:20px;
  display:grid; grid-template-rows:auto 1fr auto; gap:16px; border-radius:16px;
  background-color:rgba(var(--panel-color-rgb,255,255,255),.7);
  backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px);
  box-shadow:0 6px 24px rgba(0,0,0,.10),0 2px 8px rgba(0,0,0,.06);
  opacity:0; pointer-events:none; transition:opacity .3s ease;
}
.dark-theme .settings-panel{ --panel-color-rgb:44,44,46; }
.settings-panel.visible{ opacity:1; pointer-events:auto; }
.settings-panel::after{
  content:""; position:absolute; inset:0; pointer-events:none;
  background:linear-gradient(to bottom, rgba(0,0,0,.04), transparent 30%);
}

/* Reduced motion */
@media (prefers-reduced-motion:reduce){ *{ transition:none !important; animation:none !important; } }
@supports not ((backdrop-filter: blur(10px)) or (-webkit-backdrop-filter: blur(10px))){
  .settings-panel{ backdrop-filter:none; -webkit-backdrop-filter:none; background-color: color-mix(in srgb, var(--panel-color) 92%, transparent); }
}

/* Panel header */
.settings-panel-header{ display:flex; align-items:center; justify-content:space-between; }
.settings-panel-header h2{ margin:0; font-size:.95rem; font-weight:700; letter-spacing:.02em; }

/* Panel body */
.settings-content{
  display:flex; flex-direction:column; gap:16px; overflow-y:auto; padding:4px 2px;
  scrollbar-width:none; -ms-overflow-style:none;
}
.settings-content::-webkit-scrollbar{ width:0; height:0; display:none; }

.settings-section{ display:flex; flex-direction:column; gap:10px; }
.settings-header{
  margin:0; font-size:.7rem; font-weight:600; text-transform:uppercase; letter-spacing:.08em; color:var(--fg-light-color);
}

.input-row{ display:flex; flex-direction:column; gap:6px; text-align:left; }
.input-row label{ font-size:.8rem; color:var(--fg-light-color); }
.input-row input{
  height:36px; border-radius:10px; background:#f5f6f7; border:1px solid var(--border-color);
  color:var(--fg-color); padding:6px 10px; font-size:.875rem; font-family:inherit; box-sizing:border-box;
}
.input-row small.help-text{ font-size:.72rem; color:var(--fg-light-color); }
.dark-theme .input-row input{ background:#2a2b2e; }
.dark-theme .input-row input::-webkit-calendar-picker-indicator{ filter:invert(1); }

.horizontal-toggles{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
.btn-chip{
  border:1px solid var(--border-color); background:transparent; padding:6px 10px; border-radius:999px;
  font-size:.8rem; cursor:pointer; transition:transform .15s ease, background-color .2s ease; color:var(--fg-color);
}
.btn-chip:hover{ background:var(--ring-color); transform:translateY(-1px); }
.dark-theme .btn-chip:hover{ background:rgba(255,255,255,0.12); }

/* Unit pills */
.unit-toggle{ display:flex; flex-direction:column; align-items:center; gap:8px; cursor:pointer; user-select:none; }
.unit-toggle input{ position:absolute; opacity:0; pointer-events:none; }
.unit-dot{
  position:relative; width:18px; height:18px; border-radius:999px;
  background:transparent; border:2px solid var(--border-color);
  transition: background-color .2s ease, border-color .2s ease, box-shadow .2s ease, transform .12s ease;
}
.dark-theme .unit-dot{ border-color:rgba(255,255,255,0.35); }
.unit-toggle:hover .unit-dot{ transform:translateY(-1px); box-shadow:0 0 0 3px rgba(0,0,0,0.06); }
.dark-theme .unit-toggle:hover .unit-dot{ box-shadow:0 0 0 3px rgba(255,255,255,0.10); }
@keyframes wiggle{0%{transform:translateX(0)}25%{transform:translateX(-2px)}75%{transform:translateX(2px)}100%{transform:translateX(0)}}
.invalid-flash{animation:wiggle .22s ease;}
.unit-toggle input:checked + .unit-dot{
  background: var(--fg-color);
  border-color: var(--fg-color);
  box-shadow:0 0 0 3px rgba(0,0,0,0.08);
}
.dark-theme .unit-toggle input:checked + .unit-dot{ box-shadow:0 0 0 3px rgba(255,255,255,0.18); }
.unit-toggle-label{ font-size:.72rem; font-weight:600; color:var(--fg-light-color); }
.unit-toggle input:focus-visible + .unit-dot{ outline:2px solid var(--fg-color); outline-offset:2px; }

/* Theme chips */
.theme-chip{
  width:26px; height:26px; border-radius:999px; border:2px solid var(--border-color);
  background:#ccc; cursor:pointer; padding:0; outline:none;
  box-shadow:inset 0 0 0 2px rgba(255,255,255,.55);
  transition: transform .12s ease, box-shadow .2s ease, border-color .2s ease;
}
.theme-chip:hover{ transform:translateY(-1px); }
.theme-chip.is-active{
  box-shadow:0 0 0 3px rgba(0,0,0,0.08), inset 0 0 0 2px rgba(255,255,255,0.55);
  border-color:var(--accent-color);
}
.theme-chip[data-theme="default"]{ background:linear-gradient(45deg,#ddd 0%,#fff 100%); }
.theme-chip[data-theme="violet"] { background:#5e5ce6; }
.theme-chip[data-theme="blue"]   { background:#2563eb; }
.theme-chip[data-theme="green"]  { background:#10b981; }
.theme-chip[data-theme="pink"]   { background:#ec4899; }
.theme-chip[data-theme="gold"]   { background:#d4af37; }

/* Footer */
.settings-footer{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding-top:12px; margin-top:6px; border-top:1px solid var(--border-color);
}
.footer-toolbar{ display:flex; align-items:center; gap:12px; opacity:.95; }
.dm-inline{ display:flex; align-items:center; gap:12px; }

/* Reset style screenshot-like */
.reset-inline{
  display:inline-flex; align-items:center; gap:6px;
  border:none; background:transparent; cursor:pointer; padding:6px 8px; border-radius:999px;
  font-size:.85rem; font-weight:600; letter-spacing:.01em;
  color: color-mix(in srgb, var(--fg-color) 60%, transparent);
  transition: background-color .2s ease, color .2s ease, transform .1s ease;
}
.reset-inline .reset-icon{ width:16px; height:16px; transition: transform .2s ease; }
.reset-inline:hover{
  color: var(--reset-accent);
  background: color-mix(in srgb, var(--reset-accent) 12%, transparent);
}
.dark-theme .reset-inline:hover{
  background: color-mix(in srgb, var(--reset-accent) 18%, transparent);
}
.reset-inline:active{ transform: translateY(1px); }
.reset-inline:hover .reset-icon{ transform: rotate(-22deg); }
.reset-inline:focus-visible{
  outline:2px solid var(--reset-accent);
  outline-offset:2px;
}

/* Main display */
#main-display{ text-align:center; }
.title{ margin:0 0 20px; font-size:1.125rem; font-weight:600; }
.timer-grid{ display:grid; grid-template-columns:repeat(4,1fr); gap:16px; margin-bottom:20px; }
.timer-unit{ display:flex; flex-direction:column; }
.timer-unit .number{
  font-size:2.25rem; font-weight:700; line-height:1.1; font-variant-numeric:tabular-nums; letter-spacing:.02em;
  color:var(--fg-color);
}
.has-accent .timer-unit .number{ color:var(--accent-color); }
.timer-unit .label{ font-size:.75rem; font-weight:500; opacity:.55; text-transform:uppercase; letter-spacing:.08em; }
.finished-message{ display:none; font-size:1.125rem; font-weight:600; padding:32px 0; line-height:1.4; opacity:.8; }

/* Footer text (meilleur contraste que opacity .5) */
.footer{
  margin:0; font-size:.75rem; font-weight:500;
  color: color-mix(in srgb, var(--fg-color) 60%, transparent);
}

/* SR-only */
.sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

/* Responsive */
@media (max-width:360px){
  .widget-container{ padding:16px; border-radius:12px; }
  .timer-unit .number{ font-size:1.85rem; }
  .timer-unit .label{ font-size:.68rem; }
}
@media (min-width:560px){
  .widget-container{ max-width:460px; padding:28px; }
  .timer-unit .number{ font-size:2.6rem; }
}
/* === Switch dark mode (structure input + label.slider) === */
.switch-container{ position:relative; width:44px; height:24px; }

/* l'input recouvre toute la zone (click clavier/souris) mais reste invisible */
.switch-container input{
  position:absolute; inset:0; opacity:0; cursor:pointer;
}

/* piste du switch */
.slider{
  display:block;
  position:absolute; inset:0; border-radius:999px; cursor:pointer;
  background:var(--ring-color); transition:.3s;
}

/* pastille */
.slider:before{
  content:""; position:absolute; left:2px; bottom:2px; width:20px; height:20px;
  background:#fff; border-radius:50%; transition:.3s;
  box-shadow:0 1px 2px rgba(0,0,0,0.25);
}

/* pastille à droite quand coché */
.switch-container input:checked + .slider:before{ transform:translateX(20px); }

/* thèmes & focus */
.dark-theme .slider{ background:rgba(255,255,255,0.26); }
.dark-theme .slider:before{ box-shadow:0 1px 3px rgba(0,0,0,0.55); }
.switch-container input:focus-visible + .slider{
  outline:2px solid var(--accent-color); outline-offset:2px;
  box-shadow:0 0 0 3px rgba(94,92,230,0.25);
}

/* groupe d’icônes/slider (tu utilises .dm-inline) */
.dm-inline{ display:flex; align-items:center; gap:12px; }
.dm-inline svg{ width:16px; height:16px; fill:var(--fg-light-color); opacity:.9; }
.dark-theme .dm-inline svg{ fill:rgba(255,255,255,.85); }

</style>
</head>
<body>
<div class="widget-container" id="widget-container">
  <!-- toggle -->
  <button class="settings-toggle" id="settings-toggle" aria-label="Ouvrir les paramètres" aria-controls="settings-panel" aria-expanded="false">
    <svg id="gear-icon" viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0 -.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
    <svg id="close-icon" viewBox="0 0 24 24" style="display:none;"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
  </button>

  <!-- panel -->
  <div class="settings-panel" id="settings-panel" role="dialog" aria-modal="true" aria-labelledby="settings-title" tabindex="-1">
    <div class="settings-panel-header"><h2 id="settings-title">Paramètres</h2></div>

    <div class="settings-content">
      <div class="settings-section">
        <div class="input-row">
          <label for="title-input">Titre</label>
          <input type="text" id="title-input" placeholder="Ex : Anniversaire de Marie">
        </div>
        <div class="input-row">
          <label for="target-date-input">Date de fin</label>
          <input type="datetime-local" id="target-date-input" aria-label="Date et heure de fin">
          <small id="dtl-help" class="help-text" style="display:none;">Astuce : si le sélecteur n’apparaît pas, utilisez les boutons rapides ci-dessous.</small>
        </div>
        <div class="horizontal-toggles" aria-label="Raccourcis rapides">
          <button class="btn-chip" data-mins="25">Maintenant + 25 min</button>
          <button class="btn-chip" data-mins="45">+ 45 min</button>
          <button class="btn-chip" data-mins="60">+ 1 h</button>
          <button class="btn-chip" data-mins="90">+ 1 h 30</button>
        </div>
      </div>

      <div class="settings-section">
        <h2 class="settings-header">Affichage</h2>
        <div class="horizontal-toggles" id="units-group" role="group" aria-label="Unités à afficher">
          <label class="unit-toggle"><input type="checkbox" data-unit="days" checked><span class="unit-dot" aria-hidden="true"></span><span class="unit-toggle-label">Jours</span></label>
          <label class="unit-toggle"><input type="checkbox" data-unit="hours" checked><span class="unit-dot" aria-hidden="true"></span><span class="unit-toggle-label">Heures</span></label>
          <label class="unit-toggle"><input type="checkbox" data-unit="mins"  checked><span class="unit-dot" aria-hidden="true"></span><span class="unit-toggle-label">Minutes</span></label>
          <label class="unit-toggle"><input type="checkbox" data-unit="secs"  checked><span class="unit-dot" aria-hidden="true"></span><span class="unit-toggle-label">Secondes</span></label>
        </div>
      </div>

      <div class="settings-section">
        <h2 class="settings-header">Apparence</h2>
        <div class="horizontal-toggles" id="theme-swatches" role="group" aria-label="Thèmes recommandés">
          <button class="theme-chip is-active" data-theme="default" title="Défaut"  aria-pressed="true"></button>
          <button class="theme-chip" data-theme="violet"  title="Violet"  aria-pressed="false"></button>
          <button class="theme-chip" data-theme="blue"    title="Bleu"    aria-pressed="false"></button>
          <button class="theme-chip" data-theme="green"   title="Vert"    aria-pressed="false"></button>
          <button class="theme-chip" data-theme="pink"    title="Rose"    aria-pressed="false"></button>
          <button class="theme-chip" data-theme="gold"    title="Or"      aria-pressed="false"></button>
        </div>
      </div>
    </div>

    <!-- Footer: switch gauche, Reset à droite -->
    <div class="settings-footer">
      <div class="footer-toolbar" role="group" aria-label="Actions">
        <div class="dm-inline">
          <svg class="sun-icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9zM12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5S14.76,7,12,7z M2,13h2a1,1,0,0,0,0-2H2a1,1,0,0,0,0,2zm16,0h2a1,1,0,0,0,0-2h-2a1,1,0,0,0,0,2zM11,2v2a1,1,0,0,0,2,0V2a1,1,0,0,0-2,0zm0,18v2a1,1,0,0,0,2,0v-2a1,1,0,0,0-2,0z"/></svg>
          <div class="switch-container">
            <input type="checkbox" id="dark-mode-checkbox"><label for="dark-mode-checkbox" class="slider"></label>
          </div>
          <svg class="moon-icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
        </div>
      </div>

      <button id="reset-inline" class="reset-inline" type="button" aria-label="Réinitialiser les réglages">
        <svg class="reset-icon" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M12 5V2L7 6.5 12 11V8a6 6 0 1 1-6 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span>Reset</span>
      </button>
    </div>
  </div>

  <!-- main display -->
  <div id="main-display">
    <h1 id="title" class="title"></h1>
    <div id="timer-grid" class="timer-grid">
      <div class="timer-unit" data-unit="days"><span id="days" class="number">00</span><span class="label">Jours</span></div>
      <div class="timer-unit" data-unit="hours"><span id="hours" class="number">00</span><span class="label">Heures</span></div>
      <div class="timer-unit" data-unit="minutes"><span id="minutes" class="number">00</span><span class="label">Minutes</span></div>
      <div class="timer-unit" data-unit="seconds"><span id="seconds" class="number">00</span><span class="label">Secondes</span></div>
    </div>
    <div id="finished-message" class="finished-message" aria-live="polite"></div>
    <p id="sr-remaining" class="sr-only" aria-live="polite"></p>
    <p id="sr-alert" class="sr-only" aria-live="polite"></p>
    <p id="footer" class="footer"></p>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const params=new URLSearchParams(window.location.search);
  const root=document.documentElement;

  const el={
    container:document.getElementById('widget-container'),
    title:document.getElementById('title'),
    timerGrid:document.getElementById('timer-grid'),
    finishedMessage:document.getElementById('finished-message'),
    footer:document.getElementById('footer'),
    srRemaining:document.getElementById('sr-remaining'),
    srAlert:document.getElementById('sr-alert'),
    settings:{
      toggle:document.getElementById('settings-toggle'),
      panel:document.getElementById('settings-panel'),
      titleInput:document.getElementById('title-input'),
      targetDateInput:document.getElementById('target-date-input'),
      quickBtns:document.querySelectorAll('.btn-chip'),
      gearIcon:document.getElementById('gear-icon'),
      closeIcon:document.getElementById('close-icon'),
      darkModeCheckbox:document.getElementById('dark-mode-checkbox'),
      unitToggles:document.querySelectorAll('.settings-panel input[data-unit]'),
      themeChips:document.querySelectorAll('#theme-swatches .theme-chip'),
      themeGroup:document.getElementById('theme-swatches'),
      unitsGroup:document.getElementById('units-group'),
      dtlHelp:document.getElementById('dtl-help')
    },
    resetInline:document.getElementById('reset-inline'),
    // cache refs numériques
    numRefs:{
      days:document.getElementById('days'),
      hours:document.getElementById('hours'),
      minutes:document.getElementById('minutes'),
      seconds:document.getElementById('seconds')
    }
  };

  const UNIT_MAP={days:'days',hours:'hours',mins:'minutes',secs:'seconds'};
  const THEME_MAP={violet:'#5e5ce6',blue:'#2563eb',green:'#10b981',pink:'#ec4899',gold:'#d4af37'};

  const toLocalISOString=(d)=>{ if(!d||isNaN(d.getTime())) return ""; const tz=(new Date()).getTimezoneOffset()*60000; return (new Date(d - tz)).toISOString().slice(0,16); };

  /* ---- tz helpers ---- */
  const parseOffsetString=s=>{ if(!s) return null; s=String(s).trim(); const sign=s[0]; if(sign!=='+'&&sign!=='-') return null; let rest=s.slice(1).replace(':',''); if(!(rest.length===2||rest.length===4)) return null; const hh=parseInt(rest.slice(0,2),10); const mm=rest.length===4?parseInt(rest.slice(2),10):0; if(Number.isNaN(hh)||Number.isNaN(mm)) return null; return (sign==='-'?-1:1)*(hh*60+mm); };
  const getTzOffsetMinutes=(tz, atDate) => {
    const direct = parseOffsetString(tz);
    if (direct !== null) return direct;
    try {
      const fmt = new Intl.DateTimeFormat('en-US', {
        timeZone: tz, timeZoneName: 'shortOffset', hour12: false,
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit'
      });
      const parts = fmt.formatToParts(atDate);
      const tn = (parts.find(p => p.type === 'timeZoneName') || {}).value || '';
      let sign = 1, hh = 0, mm = 0;
      const plus = tn.lastIndexOf('+'), minus = tn.lastIndexOf('-');
      const idx = Math.max(plus, minus);
      if (idx !== -1) {
        sign = tn[idx] === '-' ? -1 : 1;
        const tail = tn.slice(idx + 1).trim();
        const mmSep = tail.indexOf(':');
        if (mmSep !== -1) { hh = parseInt(tail.slice(0, mmSep), 10); mm = parseInt(tail.slice(mmSep + 1), 10); }
        else { hh = parseInt(tail, 10); mm = 0; }
        if (!Number.isNaN(hh)) return sign * (hh * 60 + (Number.isNaN(mm) ? 0 : mm));
      }
    } catch (_) {}
    try {
      const fmt = new Intl.DateTimeFormat('en-US', {
        timeZone: tz, hour12: false,
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit'
      });
      const map = fmt.formatToParts(atDate).reduce((a,p)=>{ a[p.type]=p.value; return a; }, {});
      const Y = +map.year, M = +map.month, D = +map.day, H = +map.hour, I = +map.minute, S = +map.second;
      const localLike = Date.UTC(Y, (M||1)-1, D||1, H||0, I||0, S||0);
      return Math.round((localLike - atDate.getTime()) / 60000);
    } catch (_) { return -atDate.getTimezoneOffset(); }
  };
  const parseNaiveInTZ=(str,tz)=>{ if(!str) return null; const s=String(str).trim().replace(' ','T'); const tIndex=s.indexOf('T'); if(tIndex===-1) return null; const dPart=s.slice(0,tIndex), timePart=s.slice(tIndex+1); const dSeg=dPart.split('-'), tSeg=timePart.split(':'); if(dSeg.length<3||tSeg.length<2) return null; const y=+dSeg[0], mo=+dSeg[1], d=+dSeg[2], h=+tSeg[0], mi=+tSeg[1], se=tSeg[2]?+tSeg[2]:0; if([y,mo,d,h,mi,se].some(n=>Number.isNaN(n))) return null; let t=Date.UTC(y,mo-1,d,h,mi,se); let off=getTzOffsetMinutes(tz,new Date(t)); let t2=t-off*60000; const off2=getTzOffsetMinutes(tz,new Date(t2)); if(off2!==off) t2=t-off2*60000; return new Date(t2); };
  const hasExplicitTZ=s=>{ if(!s) return false; const u=String(s); if(u.toUpperCase().includes('Z')) return true; const p=u.lastIndexOf('+'), m=u.lastIndexOf('-'); const idx=Math.max(p,m); const tPos=u.indexOf('T'); return idx!==-1 && idx>tPos; };

  /* ---- state ---- */
  const STRINGS={
    opened:"Paramètres ouverts.",
    closed:"Paramètres fermés.",
    themeApplied:(name)=>`Thème ${name} appliqué.`,
    unitsGuard:"Au moins une unité doit rester active.",
  };

  let settings={
    visibleUnits:{days:true,hours:true,minutes:true,seconds:true},
    isDark:false,
    accentColor:null,
    eventTitle:'Compte à rebours',
    eventTargetISO:null,
    userOverrodeDate:false,
    userOverrodeTitle:false,
    selectedTheme:null,
    footer:'',
    finishText:''
  };
  let config={}; let timerInterval; let lastFocused=null;

  const STORAGE_KEY='countdownSettingsV9';
  const save=()=>localStorage.setItem(STORAGE_KEY,JSON.stringify(settings));
  const load=()=>{ try{ const s=JSON.parse(localStorage.getItem(STORAGE_KEY)); if(s) settings=Object.assign(settings,s); }catch(_){ } };

  /* ---- rendering ---- */
  const updateCountdown=()=> {
    const now=Date.now();
    if(!config.targetDate||isNaN(config.targetDate.getTime())) return;
    const dist=config.targetDate.getTime()-now;
    if(dist<0){
      clearInterval(timerInterval);
      el.timerGrid.style.display='none';
      el.finishedMessage.style.display='block';
      el.finishedMessage.textContent=(settings.finishText&&settings.finishText.trim())
        ? settings.finishText
        : ((settings.eventTitle||"L'événement")+' a commencé !');
      if(el.srRemaining){ el.srRemaining.textContent = el.finishedMessage.textContent; }
      return;
    }
    el.timerGrid.style.display='grid';
    el.finishedMessage.style.display='none';
    const parts={
      days:String(Math.floor(dist/86400000)),
      hours:String(Math.floor((dist%86400000)/3600000)),
      minutes:String(Math.floor((dist%3600000)/60000)),
      seconds:String(Math.floor((dist%60000)/1000))
    };
    for(const k in parts){ el.numRefs[k].textContent = parts[k].padStart(2,'0'); }

    // Mise à jour accessible chaque minute
    if(el.srRemaining && parts.seconds === '00'){
      const d = +parts.days, h = +parts.hours, m = +parts.minutes;
      el.srRemaining.textContent = `Temps restant : ${d} jour${d>1?'s':''}, ${h} heure${h>1?'s':''}, ${m} minute${m>1?'s':''}.`;
    }
  };

  const applyUnitVisibility=(fromLoad=false)=>{
    let count=0;
    document.querySelectorAll('.timer-unit').forEach(u=>{
      const key=u.dataset.unit; const vis=settings.visibleUnits[key]!==false;
      u.style.display=vis?'flex':'none'; if(vis) count++;
    });
    el.timerGrid.style.gridTemplateColumns=`repeat(${Math.max(1,count)},1fr)`;
    el.settings.unitToggles.forEach(cb=>{ const mapped=UNIT_MAP[cb.dataset.unit]; cb.checked=!!settings.visibleUnits[mapped]; });
    if(!fromLoad) save();
  };

  // Thème
  const applyTheme=(isDark,fromLoad=false)=>{
    settings.isDark=isDark;
    el.container.classList.toggle('dark-theme',isDark);
    if(el.settings.darkModeCheckbox) el.settings.darkModeCheckbox.checked=isDark;
    if(!fromLoad) save();
  };

  const applyAccentColor=(color,fromLoad=false)=>{
    root.style.setProperty('--accent-color', color || 'var(--fg-color)');
    if(!fromLoad) save();
  };

  const syncAccentClass=()=>{ 
    if(settings.selectedTheme && THEME_MAP[settings.selectedTheme]) el.container.classList.add('has-accent');
    else el.container.classList.remove('has-accent');
  };

  const markActiveThemeChip=(activeKey)=>{
    el.settings.themeChips.forEach(b=>{
      const isActive = b.dataset.theme===activeKey;
      b.classList.toggle('is-active', isActive);
      b.setAttribute('aria-pressed', isActive ? 'true' : 'false');
    });
  };

  const applyThemePreset=(key,fromLoad=false)=>{
    if(!THEME_MAP[key]) return;
    settings.selectedTheme=key; settings.accentColor=THEME_MAP[key];
    applyAccentColor(settings.accentColor,true); syncAccentClass(); markActiveThemeChip(key);
    if(el.srAlert) el.srAlert.textContent = STRINGS.themeApplied(key);
    if(!fromLoad) save();
  };

  const resetToDefaultTheme=()=>{
    settings.selectedTheme=null; settings.accentColor=null;
    applyAccentColor(null,true); syncAccentClass(); markActiveThemeChip('default'); save();
    if(el.srAlert) el.srAlert.textContent = STRINGS.themeApplied('défaut');
  };

  // Tick aligné
  const restartTick=()=>{
    clearInterval(timerInterval);
    updateCountdown();
    const delay = 1000 - (Date.now() % 1000);
    setTimeout(()=>{
      updateCountdown();
      timerInterval=setInterval(updateCountdown,1000);
    }, delay);
  };

  /* ---- a11y dialog ---- */
  const getFocusable=c=>[...c.querySelectorAll('a,button,input,select,textarea,[tabindex]:not([tabindex="-1"])')]
    .filter(node=>!node.hasAttribute('disabled') && node.getClientRects().length>0);

  const showPanel=show=>{
    el.settings.panel.classList.toggle('visible',show);
    el.container.classList.toggle('settings-active',show);
    el.settings.gearIcon.style.display=show?'none':'block';
    el.settings.closeIcon.style.display=show?'block':'none';
    el.settings.toggle.setAttribute('aria-expanded',show?'true':'false');
    if(show) clearInterval(timerInterval); else restartTick();
  };
  const openPanel=()=>{
    lastFocused=document.activeElement; showPanel(true);
    const main=document.getElementById('main-display'); if('inert'in main) main.inert=true; else main.setAttribute('aria-hidden','true');
    const f=getFocusable(el.settings.panel); (f[0]||el.settings.titleInput||el.settings.panel).focus();
    if(el.srAlert) el.srAlert.textContent = STRINGS.opened;
  };
  const closePanel=()=>{
    showPanel(false);
    const main=document.getElementById('main-display'); if('inert'in main) main.inert=false; else main.removeAttribute('aria-hidden');
    (lastFocused||el.settings.toggle).focus();
    if(el.srAlert) el.srAlert.textContent = STRINGS.closed;
  };

  /* ---- reset soft ---- */
  const DEFAULTS = () => ({
    visibleUnits:{days:true,hours:true,minutes:true,seconds:true},
    isDark:false,
    accentColor:null,
    eventTitle:'Compte à rebours',
    eventTargetISO:new Date(Date.now()+24*60*60*1000).toISOString(),
    userOverrodeDate:false,
    userOverrodeTitle:false,
    selectedTheme:null,
    footer:'',
    finishText:''
  });

  const resetSettings = () => {
    settings = DEFAULTS();
    save();

    applyTheme(settings.isDark,true);
    applyAccentColor(null,true);
    syncAccentClass();
    markActiveThemeChip('default');

    applyUnitVisibility(true);
    el.footer.textContent=''; el.footer.style.display='none';

    el.settings.titleInput.value = settings.eventTitle;
    el.title.textContent = settings.eventTitle;

    const d = new Date(settings.eventTargetISO);
    el.settings.targetDateInput.value = toLocalISOString(d);
    el.settings.targetDateInput.min = toLocalISOString(new Date()); // grise les dates passées
    config.targetDate = d;

    restartTick();
    if(el.srAlert) el.srAlert.textContent = 'Réglages réinitialisés.';
  };

  /* ---- listeners ---- */
  el.settings.toggle.addEventListener('click',()=> el.settings.panel.classList.contains('visible') ? closePanel() : openPanel());
  el.settings.panel.addEventListener('keydown',(e)=>{
    if(e.key==='Escape'){ e.preventDefault(); closePanel(); return; }
    if(e.key==='Tab' && el.settings.panel.classList.contains('visible')){
      const f=getFocusable(el.settings.panel); if(!f.length) return;
      const first=f[0], last=f[f.length-1];
      if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); }
      else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); }
    }
  });
  el.settings.panel.addEventListener('click',(e)=>{ if(e.target === el.settings.panel) closePanel(); });

  el.settings.titleInput.addEventListener('input',e=>{
    settings.eventTitle=e.target.value||'Compte à rebours';
    settings.userOverrodeTitle=true; save();
    el.title.textContent=settings.eventTitle;
  });

  el.settings.targetDateInput.addEventListener('input',e=>{
    const d=e.target.value ? new Date(e.target.value) : null;
    if(!d||isNaN(d.getTime())) return;
    settings.eventTargetISO=d.toISOString(); settings.userOverrodeDate=true; save();
    config.targetDate=d; restartTick();
  });

  el.settings.quickBtns.forEach(b=>b.addEventListener('click',e=>{
    const mins=Math.max(1,Math.min(720,Number(e.currentTarget.dataset.mins)));
    const d=new Date(Date.now()+mins*60000);
    settings.eventTargetISO=d.toISOString(); settings.userOverrodeDate=true; save();
    el.settings.targetDateInput.value=toLocalISOString(d);
    config.targetDate=d; restartTick();
  }));

  el.settings.unitToggles.forEach(cb=>cb.addEventListener('change', e=>{
    const mapped = UNIT_MAP[e.target.dataset.unit];
    const totalChecked = [...el.settings.unitToggles].filter(x=>x.checked).length;
    if(totalChecked === 0){
      e.target.checked = true;
      const group = el.settings.unitsGroup;
      if(group){
        group.classList.remove('invalid-flash');
        void group.offsetWidth;
        group.classList.add('invalid-flash');
      }
      if(el.srAlert) el.srAlert.textContent = STRINGS.unitsGuard;
      return;
    }
    settings.visibleUnits[mapped] = e.target.checked;
    applyUnitVisibility();
  }));

  el.settings.themeChips.forEach(btn=>{
    btn.addEventListener('click',()=>{
      const key=btn.dataset.theme;
      if(key==='default') resetToDefaultTheme();
      else applyThemePreset(key);
    });
  });

  const dm=el.settings.darkModeCheckbox;
  if(dm){
    dm.addEventListener('change',e=>applyTheme(e.target.checked));
    document.querySelector('.dark-mode-toggle')?.addEventListener('click',ev=>{
      if(ev.target===dm || ev.target.closest('label')?.htmlFor==='dark-mode-checkbox') return;
      dm.checked=!dm.checked; applyTheme(dm.checked);
    });
  }

  if(el.resetInline){
    el.resetInline.addEventListener('click',(e)=>{ e.preventDefault(); resetSettings(); });
  }

  /* ---- init ---- */
  const init=()=>{
    load();

    if(!settings.eventTitle || !String(settings.eventTitle).trim()){
      settings.eventTitle = 'Compte à rebours';
      settings.userOverrodeTitle = false;
    }

    const themeParam=params.get('theme');
    const accentParam=params.get('accent');
    const unitsParam=params.get('units');
    const footerParam=params.get('footer');
    const titleParam=params.get('title');
    const dateParam=params.get('date');
    const durationParam=params.get('duration') ?? params.get('minutes');
    const tzParam=params.get('tz');
    const finishParam=params.get('finish');
    const lockParam=params.get('lock');

    if(params.get('compact')==='1') document.body.classList.add('compact');
    if(lockParam==='1'||/^(true|yes)$/i.test(String(lockParam||''))) el.settings.toggle.style.display='none';

    if(themeParam==='dark') settings.isDark=true;
    else if(themeParam==='light') settings.isDark=false;
    else if(themeParam && THEME_MAP[themeParam]){ settings.selectedTheme=themeParam; settings.accentColor=THEME_MAP[themeParam]; }

    if(accentParam && !(themeParam && THEME_MAP[themeParam])){
      const hex=`#${accentParam.replace(/[^0-9a-fA-F]/g,'')}`;
      if(hex.length===4 || hex.length===7){ settings.accentColor=hex; settings.selectedTheme=null; }
    }

    if(typeof footerParam==='string') settings.footer=footerParam;
    if(typeof finishParam==='string') settings.finishText=finishParam;
    if(typeof titleParam==='string' && !settings.userOverrodeTitle) settings.eventTitle=titleParam || 'Compte à rebours';

    if(unitsParam){
      const u=unitsParam.toLowerCase();
      settings.visibleUnits={ days:u.includes('d'), hours:u.includes('h'), minutes:u.includes('m'), seconds:u.includes('s') };
      if(!Object.values(settings.visibleUnits).some(Boolean)){
        settings.visibleUnits = { days:false, hours:false, minutes:true, seconds:true };
      }
    }

    // cible
    let target=null;
    if(settings.userOverrodeDate && settings.eventTargetISO){ const t=new Date(settings.eventTargetISO); if(!isNaN(t.getTime())) target=t; }
    if(!target && dateParam){
      let d=null;
      if(hasExplicitTZ(dateParam)) d=new Date(dateParam);
      else if(tzParam) d=parseNaiveInTZ(dateParam,tzParam) || new Date(dateParam);
      else d=new Date(dateParam);
      if(!isNaN(d.getTime())) target=d;
    }
    if(!target && durationParam){
      const mins=Math.max(1,Math.min(720,Number(durationParam)));
      if(!Number.isNaN(mins)) target=new Date(Date.now()+mins*60000);
    }
    if(!target && settings.eventTargetISO){
      const p=new Date(settings.eventTargetISO);
      if(!isNaN(p.getTime())) target=p;
    }
    if(!target) target=new Date(Date.now()+24*60*60*1000);

    settings.eventTargetISO=target.toISOString();

    // thème / accent
    applyTheme(settings.isDark,true);
    if(settings.selectedTheme && THEME_MAP[settings.selectedTheme]) applyThemePreset(settings.selectedTheme,true);
    else { applyAccentColor(null,true); markActiveThemeChip('default'); }
    syncAccentClass();

    // unités + footer
    applyUnitVisibility(true);
    if(settings.footer && settings.footer.trim()){ el.footer.textContent=settings.footer; el.footer.style.display=''; }
    else { el.footer.textContent=''; el.footer.style.display='none'; }

    // inputs
    el.settings.titleInput.value=settings.eventTitle || '';
    el.title.textContent=settings.eventTitle || '';
    el.settings.targetDateInput.value=toLocalISOString(target);

    // Griser les dates passées : min = maintenant
    el.settings.targetDateInput.min = toLocalISOString(new Date());

    // feature detection datetime-local (aide)
    try{
      if(!('valueAsDate' in el.settings.targetDateInput)) el.settings.dtlHelp.style.display='';
    }catch(_){}

    config.targetDate=target;
    updateCountdown();
    const delay = 1000 - (Date.now() % 1000);
    setTimeout(()=>{ updateCountdown(); timerInterval=setInterval(updateCountdown,1000); }, delay);
    save();
  };

  init();
});
</script>
</body>
</html>
